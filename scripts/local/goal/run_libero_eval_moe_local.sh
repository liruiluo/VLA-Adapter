#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root (works locally, from anywhere, and under Slurm)
if [ -n "${SLURM_SUBMIT_DIR-}" ] && [ -d "${SLURM_SUBMIT_DIR}" ]; then
  ROOT_DIR="${SLURM_SUBMIT_DIR}"
elif command -v git >/dev/null 2>&1 && git -C "${PWD}" rev-parse --show-toplevel >/dev/null 2>&1; then
  ROOT_DIR="$(git -C "${PWD}" rev-parse --show-toplevel)"
else
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  ROOT_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
fi
cd "${ROOT_DIR}"

# Optional: load user conda base, then project env via setup_libero_env.sh
if [ -f "${HOME}/miniconda3/etc/profile.d/conda.sh" ]; then
  . "${HOME}/miniconda3/etc/profile.d/conda.sh"
fi

source "${ROOT_DIR}/scripts/setup_libero_env.sh"

# === Stable headless rendering defaults ===
# - Prefer GLFW under Xvfb (more stable than osmesa on many machines)
# - Respect user override if MUJOCO_GL is already set.
export MUJOCO_GL="${MUJOCO_GL:-glfw}"
unset PYOPENGL_PLATFORM
export TOKENIZERS_PARALLELISM="${TOKENIZERS_PARALLELISM:-false}"
export PYTHONUNBUFFERED="${PYTHONUNBUFFERED:-1}"

RUNNER=()
if [ -z "${DISPLAY-}" ] && command -v xvfb-run >/dev/null 2>&1; then
  RUNNER=(xvfb-run -s "-screen 0 1280x1024x24")
elif [ -z "${DISPLAY-}" ]; then
  echo "[WARN] DISPLAY is not set and xvfb-run is not available; MuJoCo rendering may fail." >&2
fi

# Force use of project conda env python (has draccus, libero, etc.)
PY_BIN="${ROOT_DIR}/env/bin/python"

# Ensure robosuite does not force EGL on Linux (common source of headless crashes).
SITE_PACKAGES="$("${PY_BIN}" -c "import site; print(site.getsitepackages()[0])")"
ROBOSUITE_MACROS_PRIVATE="${SITE_PACKAGES}/robosuite/macros_private.py"
if [ ! -f "${ROBOSUITE_MACROS_PRIVATE}" ]; then
  echo "[INFO] Creating robosuite macros override at: ${ROBOSUITE_MACROS_PRIVATE}"
  cat >"${ROBOSUITE_MACROS_PRIVATE}" <<'PY'
# Auto-generated by VLA-Adapter eval scripts to improve headless stability.
MUJOCO_GPU_RENDERING = False
PY
fi

# === MoE-LoRA LIBERO-Goal eval ===

CKPT_DIR="${CKPT_DIR:-}"
if [ -z "${CKPT_DIR}" ]; then
  echo "[ERROR] Please set CKPT_DIR to a MoE-LoRA finetune checkpoint directory (contains moe_lora--*_checkpoint.pt)." >&2
  exit 1
fi

CONFIG_DIR="${CONFIG_DIR:-pretrained_models/configs}"
TASK_SUITE_NAME="${TASK_SUITE_NAME:-libero_goal}"

CUDA_VISIBLE_DEVICES="${CUDA_VISIBLE_DEVICES-0}" "${RUNNER[@]}" "${PY_BIN}" experiments/robot/libero/run_libero_eval.py \
  --model_family openvla \
  --pretrained_checkpoint "${CKPT_DIR}" \
  --config_file_path "${CONFIG_DIR}" \
  --use_moe_lora True \
  --moe_num_experts 3 \
  --moe_top_k 2 \
  --moe_target_modules "all-linear" \
  --lora_rank 64 \
  --use_l1_regression True \
  --use_minivlm True \
  --use_film False \
  --num_images_in_input 2 \
  --use_proprio True \
  --task_suite_name "${TASK_SUITE_NAME}" \
  --env_img_res "${ENV_IMG_RES-128}" \
  --num_trials_per_task 50 \
  --use_pro_version True \
  "$@"

